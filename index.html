<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galactic Forge X - Ultimate ECF Editor</title>
    <!-- Iconos Material Design -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        /* --- TEMA DINÁMICO (Variables CSS) --- */
        :root { 
            /* Colores Base (Se sobreescriben con JS) */
            --bg: #121212; 
            --panel: #1e1e1e; 
            --border: #333333; 
            --text: #e0e0e0;
            --text-mute: #9e9e9e;
            --input-bg: #2c2c2c;
            --accent: #00e676; 
            --accent-hover: #00c853;

            /* Variables de Layout */
            --sidebar-width: 360px;
            --dash-size: 40vh; /* Altura o Ancho según modo */
            --base-font-size: 14px;
            
            /* Colores Fijos de Categorías (Semánticos) */
            --c-weapon: #ef5350;    
            --c-food: #66bb6a;      
            --c-device: #42a5f5;    
            --c-block: #ffa726;     
            --changed: #ff9100;     
        }

        body { font-family: 'Segoe UI', 'Roboto', monospace; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; font-size: var(--base-font-size); }

        /* --- SIDEBAR --- */
        #sidebar { width: var(--sidebar-width); background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 10; flex-shrink: 0; box-shadow: 2px 0 10px rgba(0,0,0,0.5); transition: width 0.1s; }

        .sidebar-header { 
            padding: 20px; 
            background: rgba(0,0,0,0.2); /* Sutil transparencia sobre el color del panel */
            border-bottom: 1px solid var(--border); 
            display: flex; justify-content: space-between; align-items: flex-start;
        }
        .header-left { display: flex; flex-direction: column; gap: 5px; }
        
        .app-title { display: flex; align-items: center; gap: 10px; font-size: 1.2em; font-weight: bold; color: var(--text); letter-spacing: 1px; }
        .app-title .material-icons { color: var(--accent); }
        .version-badge { font-size: 0.7em; background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 10px; color: var(--accent); align-self: flex-start; margin-left: 34px; }

        .settings-btn { background: transparent; border: none; color: var(--text-mute); cursor: pointer; padding: 5px; border-radius: 50%; transition: 0.3s; }
        .settings-btn:hover { color: var(--accent); background: rgba(255,255,255,0.1); transform: rotate(90deg); }

        /* Pestañas */
        .mode-tabs { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; background: rgba(0,0,0,0.2); padding: 5px; gap: 2px; }
        .tab-btn { padding: 10px 5px; border: none; background: transparent; color: var(--text-mute); cursor: pointer; font-weight: bold; font-size: 0.75em; transition: 0.2s; border-bottom: 2px solid transparent; text-transform: uppercase; }
        .tab-btn:hover { color: var(--text); background: rgba(255,255,255,0.05); }
        .tab-btn.active { background: var(--input-bg); color: var(--accent); border-bottom-color: var(--accent); }

        /* Buscador */
        .search-area { padding: 10px; background: var(--panel); border-bottom: 1px solid var(--border); }
        .search-box { position: relative; display: flex; align-items: center; margin-bottom: 10px; }
        .search-box .material-icons { position: absolute; left: 10px; color: var(--text-mute); }
        #searchInput { width: 100%; background: var(--input-bg); border: 1px solid var(--border); color: var(--text); padding: 8px 10px 8px 35px; border-radius: 4px; outline: none; }
        #searchInput:focus { border-color: var(--accent); }

        .filter-chips { display: flex; gap: 6px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .chip { padding: 4px 10px; font-size: 0.75em; background: var(--input-bg); border: 1px solid var(--border); border-radius: 12px; color: var(--text-mute); cursor: pointer; white-space: nowrap; transition: 0.2s; user-select: none; }
        .chip.active { background: var(--accent); color: #000; font-weight: bold; border-color: var(--accent); }
        
        .file-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding-top: 10px; border-top: 1px solid var(--border); margin-top: 5px; }

        /* Lista */
        #object-list { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; }
        .list-item { padding: 12px 15px; cursor: pointer; border-bottom: 1px solid var(--border); border-left: 4px solid transparent; transition: 0.1s; display: flex; justify-content: space-between; align-items: center; }
        .list-item:hover { background: rgba(255,255,255,0.05); }
        .list-item.active { background: var(--input-bg); border-left-color: var(--accent); }
        .list-item.type-weapon { border-left-color: var(--c-weapon); }
        .list-item.type-food { border-left-color: var(--c-food); }
        .item-info { display: flex; flex-direction: column; }
        .item-name { font-weight: bold; font-size: 0.95em; color: var(--text); }
        .item-id { font-size: 0.75em; color: var(--text-mute); font-family: monospace; }
        
        /* --- EDITOR PRINCIPAL (Flexible) --- */
        #editor-area { flex: 1; display: flex; flex-direction: column; background: var(--bg); position: relative; transition: all 0.3s ease; }
        
        /* Layout: Dashboard a la DERECHA */
        #editor-area.layout-right { flex-direction: row; }
        #editor-area.layout-right #visual-dashboard { 
            width: var(--dash-size); 
            height: 100%; 
            max-height: 100%; 
            border-bottom: none; 
            border-left: 1px solid var(--border);
            order: 2; /* Poner al final (derecha) */
        }
        #editor-area.layout-right #scroll-wrapper { order: 1; flex: 1; }

        /* Contenedor interno para scroll cuando layout-right */
        #scroll-wrapper { flex: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden; }

        #editor-header { padding: 15px 20px; background: var(--panel); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        #editor-header h2 { margin: 0; color: var(--accent); font-size: 1.4em; display: flex; align-items: center; gap: 10px; }
        .header-actions { display: flex; gap: 10px; }

        /* --- VISUAL DASHBOARD --- */
        #visual-dashboard {
            padding: 10px 20px;
            background: rgba(0,0,0,0.1); /* Ligeramente más oscuro que el fondo */
            border-bottom: 1px solid var(--border);
            display: none; 
            max-height: var(--dash-size); 
            overflow-y: auto;
            animation: fadeIn 0.3s;
            box-sizing: border-box;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .mode-section { margin-bottom: 15px; background: var(--panel); border: 1px solid var(--border); border-radius: 6px; padding: 10px; }
        .mode-title { font-size: 0.8em; color: var(--accent); text-transform: uppercase; font-weight: bold; margin-bottom: 8px; border-bottom: 1px solid var(--border); padding-bottom: 4px; display: flex; align-items: center; gap: 5px; }

        .combat-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 8px; }
        
        .combat-stat-box { background: var(--input-bg); border: 1px solid var(--border); border-radius: 4px; padding: 6px; display: flex; flex-direction: column; transition: 0.2s; }
        .combat-stat-box:hover { border-color: var(--text-mute); background: rgba(255,255,255,0.05); }
        
        .cs-label { font-size: 0.6em; color: var(--text-mute); text-transform: uppercase; font-weight: bold; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .cs-input { background: transparent; border: none; color: var(--text); font-family: 'Consolas', monospace; font-size: 1.1em; font-weight: bold; width: 100%; border-bottom: 2px solid transparent; padding: 2px 0; }
        .cs-input:focus { outline: none; border-bottom-color: var(--accent); }
        
        .inp-dmg { color: #ff5252; }
        .inp-rof { color: #ffd740; }
        .inp-zoom { color: #e040fb; }
        .inp-ammo { color: #69f0ae; }
        .inp-range { color: #448aff; }
        .inp-dur { color: var(--text-mute); }
        .inp-energy { color: #40c4ff; }
        .inp-harvest { color: #8d6e63; }
        .inp-repair { color: #29b6f6; }

        /* Food Grid */
        .food-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; }
        .food-item { display: flex; flex-direction: column; align-items: center; background: var(--input-bg); padding: 10px; border-radius: 6px; border: 1px solid var(--border); }
        .food-icon { font-size: 2em; margin-bottom: 5px; }
        .food-val { font-size: 1.2em; font-weight: bold; background:transparent; border:none; text-align:center; color:inherit; width:100%; }
        .c-health { color: #ff5252; }
        .c-food { color: #ffab40; }
        .c-stamina { color: #40c4ff; }

        /* Scroll de Propiedades */
        #props-scroll { flex: 1; overflow-y: auto; padding: 20px 40px; }
        .prop-row { display: flex; margin-bottom: 8px; align-items: center; font-family: 'Consolas', monospace; }
        .prop-key { width: 220px; color: var(--text-mute); text-align: right; padding-right: 15px; font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .prop-val { flex: 1; background: var(--input-bg); border: 1px solid var(--border); color: var(--text); padding: 8px 12px; font-family: inherit; border-radius: 4px; font-size: 0.95em; transition: 0.2s; }
        .prop-val:focus { border-color: var(--accent); outline: none; background: rgba(255,255,255,0.05); }
        .prop-val.modified { border-color: var(--changed); color: var(--changed); background: rgba(255, 145, 0, 0.1); }
        
        .nested-header { margin-top: 25px; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid var(--border); color: var(--text); font-weight: bold; display: flex; align-items: center; gap: 10px; font-size: 1.1em; }
        .nested-block { margin-left: 20px; border-left: 2px solid var(--border); padding-left: 15px; }

        /* Botones */
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 0.85em; transition: 0.2s; }
        .btn-primary { background: var(--accent); color: #000; } .btn-primary:hover { background: var(--accent-hover); }
        .btn-sec { background: var(--input-bg); color: var(--text); border: 1px solid var(--border); } .btn-sec:hover { background: var(--border); }
        .btn-code { background: #7c4dff; }
        .btn-full { background: #3f51b5; width: 100%; margin-top: 5px; }
        
        .empty-state { text-align: center; margin-top: 15%; color: var(--text-mute); }
        .empty-state .material-icons { font-size: 4em; margin-bottom: 10px; opacity: 0.5; }

        /* --- MODALES --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; backdrop-filter: blur(2px); }
        .modal-content { position:relative; margin: 5vh auto; width: 80%; height: 85vh; background: var(--bg); border: 1px solid var(--border); display: flex; flex-direction: column; border-radius: 8px; box-shadow: 0 10px 30px black; color: var(--text); }
        
        /* Modal Pequeño para Configuración */
        #settings-modal .modal-content { width: 450px; height: auto; max-height: 90vh; margin: 5vh auto; }

        .code-view { flex: 1; padding: 20px; overflow: auto; background: #0a0a0a; color: #a9b7c6; font-family: 'Consolas', monospace; font-size: 0.9em; white-space: pre; }
        .line-mod { background: rgba(255, 145, 0, 0.1); border-left: 3px solid var(--changed); padding-left: 5px; display: block; width: 100%; }
        
        /* Controles de Configuración */
        .setting-group { padding: 15px 20px; border-bottom: 1px solid var(--border); }
        .setting-group h4 { margin-top: 0; color: var(--accent); margin-bottom: 10px; }
        .setting-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .setting-row label { color: var(--text); font-size: 0.9em; }
        
        /* Inputs Custom */
        input[type=range] { width: 140px; accent-color: var(--accent); }
        input[type=color] { border: none; width: 40px; height: 30px; cursor: pointer; background: transparent; }
        select { background: var(--input-bg); color: var(--text); border: 1px solid var(--border); padding: 5px; border-radius: 4px; }
        
        .range-val { font-family: monospace; color: var(--accent); width: 45px; text-align: right; font-size: 0.8em; }

        #notification { position: fixed; bottom: 20px; right: 20px; background: var(--panel); color: var(--text); padding: 15px 25px; border-radius: 4px; border-left: 4px solid var(--accent); transform: translateY(100px); transition: 0.3s; opacity: 0; z-index: 200; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        #notification.show { transform: translateY(0); opacity: 1; }
    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <div id="sidebar">
        <div class="sidebar-header">
            <div class="header-left">
                <div class="app-title"><span class="material-icons">science</span> GALACTIC FORGE X</div>
                <div class="version-badge">v15.0 CHAMELEON</div>
            </div>
            <!-- BOTÓN ENGRANAJE -->
            <button class="settings-btn" onclick="UI.toggleSettings()" title="Apariencia y Layout">
                <span class="material-icons">settings</span>
            </button>
        </div>

        <div class="mode-tabs">
            <button class="tab-btn active" onclick="APP.switchMode('item')" data-mode="item">ITEMS</button>
            <button class="tab-btn" onclick="APP.switchMode('block')" data-mode="block">BLOCKS</button>
            <button class="tab-btn" onclick="APP.switchMode('template')" data-mode="template">RECIPES</button>
            <button class="tab-btn" onclick="APP.switchMode('material')" data-mode="material">MATS</button>
        </div>

        <div class="search-area">
            <div class="search-box">
                <span class="material-icons">search</span>
                <input type="text" id="searchInput" placeholder="Buscar ID, Nombre..." onkeyup="UI.renderList()">
            </div>
            <div id="filter-container" class="filter-chips"></div>
            
            <div class="file-controls">
                <input type="file" id="fileInput" accept=".txt,.ecf" style="display:none">
                <button class="btn btn-sec" onclick="document.getElementById('fileInput').click()">
                    <span class="material-icons">folder_open</span> Abrir
                </button>
                <button class="btn btn-primary" onclick="DATA.downloadConfig()">
                    <span class="material-icons">save</span> Guardar
                </button>
            </div>
            <button class="btn btn-full" onclick="UI.showFullCode()">
                <span class="material-icons">description</span> Ver Archivo Completo
            </button>
        </div>

        <ul id="object-list"></ul>
    </div>

    <!-- MAIN EDITOR -->
    <div id="editor-area">
        <!-- Wrapper para Scroll (Necesario para layout flexible) -->
        <div id="scroll-wrapper">
            <div id="editor-header" style="display:none;">
                <h2 id="editor-title"><span class="material-icons">edit</span> Item Name</h2>
                <div class="header-actions">
                    <button class="btn btn-code" onclick="UI.showCodeInspector(false)" title="Ver Código">
                        <span class="material-icons">code</span> ECF Item
                    </button>
                    <button class="btn btn-sec" onclick="DATA.cloneItem()" title="Duplicar">
                        <span class="material-icons">content_copy</span>
                    </button>
                </div>
            </div>

            <div id="props-scroll">
                <div class="empty-state">
                    <span class="material-icons">account_tree</span>
                    <h2>Editor Listo</h2>
                    <p>Carga un archivo <code>.ecf</code> para comenzar.</p>
                </div>
            </div>
        </div>

        <!-- VISUAL DASHBOARD (Se mueve con CSS Flexbox) -->
        <div id="visual-dashboard"></div>
    </div>

    <!-- MODAL CÓDIGO -->
    <div id="code-modal" class="modal-overlay">
        <div class="modal-content">
            <div style="padding:15px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; background:var(--panel);">
                <span id="modal-title" style="font-weight:bold; color:var(--accent);">INSPECTOR DE CÓDIGO</span>
                <button class="btn btn-sec" onclick="document.getElementById('code-modal').style.display='none'">CERRAR</button>
            </div>
            <div class="code-view" id="code-container"></div>
        </div>
    </div>

    <!-- MODAL CONFIGURACIÓN -->
    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content">
            <div style="padding:15px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; background:var(--panel);">
                <span style="font-weight:bold; color:var(--text);"><span class="material-icons" style="vertical-align:middle; font-size:1.1em; color:var(--accent)">settings</span> CONFIGURACIÓN</span>
                <button class="btn btn-sec" onclick="UI.toggleSettings()">CERRAR</button>
            </div>
            <div style="padding:0; flex:1; overflow-y:auto;">
                
                <!-- Layout -->
                <div class="setting-group">
                    <h4>Distribución (Layout)</h4>
                    <div class="setting-row">
                        <label>Posición Dashboard</label>
                        <select id="set-layout-mode" onchange="CONFIG.update('layout', this.value)">
                            <option value="top">Arriba (Clásico)</option>
                            <option value="right">Derecha (Vertical)</option>
                        </select>
                    </div>
                    <div class="setting-row">
                        <label id="lbl-dash-size">Altura Dashboard</label>
                        <div style="display:flex; align-items:center; gap:10px">
                            <input type="range" min="20" max="70" value="40" id="set-dash-size" oninput="CONFIG.update('dash', this.value)">
                            <span class="range-val" id="val-dash">40%</span>
                        </div>
                    </div>
                    <div class="setting-row">
                        <label>Ancho Barra Lateral</label>
                        <div style="display:flex; align-items:center; gap:10px">
                            <input type="range" min="250" max="600" value="360" id="set-sidebar-width" oninput="CONFIG.update('sidebar', this.value)">
                            <span class="range-val" id="val-sidebar">360px</span>
                        </div>
                    </div>
                    <div class="setting-row">
                        <label>Tamaño Fuente</label>
                        <div style="display:flex; align-items:center; gap:10px">
                            <input type="range" min="12" max="18" value="14" id="set-font-size" oninput="CONFIG.update('font', this.value)">
                            <span class="range-val" id="val-font">14px</span>
                        </div>
                    </div>
                </div>

                <!-- Colores -->
                <div class="setting-group">
                    <h4>Apariencia (Colores)</h4>
                    <div class="setting-row"><label>Color de Acento</label> <input type="color" id="col-accent" oninput="CONFIG.updateColor('accent', this.value)"></div>
                    <div class="setting-row"><label>Fondo Principal</label> <input type="color" id="col-bg" oninput="CONFIG.updateColor('bg', this.value)"></div>
                    <div class="setting-row"><label>Paneles / Sidebar</label> <input type="color" id="col-panel" oninput="CONFIG.updateColor('panel', this.value)"></div>
                    <div class="setting-row"><label>Inputs / Cajas</label> <input type="color" id="col-input" oninput="CONFIG.updateColor('input-bg', this.value)"></div>
                    <div class="setting-row"><label>Bordes</label> <input type="color" id="col-border" oninput="CONFIG.updateColor('border', this.value)"></div>
                    <div class="setting-row"><label>Texto Principal</label> <input type="color" id="col-text" oninput="CONFIG.updateColor('text', this.value)"></div>
                </div>

                <div class="setting-group" style="text-align:center; display:flex; gap:10px;">
                    <button class="btn btn-sec" onclick="CONFIG.resetLayout()" style="flex:1">Reset Layout</button>
                    <button class="btn btn-sec" onclick="CONFIG.resetColors()" style="flex:1">Reset Colores</button>
                </div>
            </div>
        </div>
    </div>

    <div id="notification">Operación Exitosa</div>

    <script>
        const NOTIFY = (msg) => {
            const el = document.getElementById('notification');
            el.innerText = msg;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 3000);
        };

        // --- SISTEMA DE CONFIGURACIÓN AVANZADO ---
        const CONFIG = {
            defaults: { 
                sidebar: 360, dash: 40, font: 14, layout: 'top',
                colors: {
                    accent: '#00e676', bg: '#121212', panel: '#1e1e1e', 
                    border: '#333333', text: '#e0e0e0', 'input-bg': '#2c2c2c'
                }
            },
            
            init: function() {
                const saved = JSON.parse(localStorage.getItem('gforge_v15_config')) || {};
                
                // Aplicar Layout
                this.update('sidebar', saved.sidebar || this.defaults.sidebar);
                this.update('dash', saved.dash || this.defaults.dash);
                this.update('font', saved.font || this.defaults.font);
                this.update('layout', saved.layout || this.defaults.layout);

                // Aplicar Colores
                const savedColors = saved.colors || this.defaults.colors;
                Object.keys(savedColors).forEach(k => this.updateColor(k, savedColors[k], false));
            },

            update: function(key, val) {
                const root = document.documentElement.style;
                const area = document.getElementById('editor-area');
                
                if(key === 'sidebar') {
                    root.setProperty('--sidebar-width', val + 'px');
                    document.getElementById('val-sidebar').innerText = val + 'px';
                    document.getElementById('set-sidebar-width').value = val;
                }
                if(key === 'dash') {
                    // Si el layout es 'right', usamos vw o px fijo, si es top usamos vh
                    const isRight = document.getElementById('set-layout-mode').value === 'right';
                    const unit = isRight ? 'px' : 'vh';
                    const cssVal = isRight ? (val * 10) : val; // Escalar para px (40 -> 400px)
                    
                    root.setProperty('--dash-size', cssVal + unit);
                    document.getElementById('val-dash').innerText = val + (isRight ? '0px' : '%');
                    document.getElementById('set-dash-size').value = val;
                }
                if(key === 'font') {
                    root.setProperty('--base-font-size', val + 'px');
                    document.getElementById('val-font').innerText = val + 'px';
                    document.getElementById('set-font-size').value = val;
                }
                if(key === 'layout') {
                    if(val === 'right') {
                        area.classList.add('layout-right');
                        document.getElementById('lbl-dash-size').innerText = "Ancho Dashboard";
                    } else {
                        area.classList.remove('layout-right');
                        document.getElementById('lbl-dash-size').innerText = "Altura Dashboard";
                    }
                    document.getElementById('set-layout-mode').value = val;
                    // Forzar actualización de dash size con la nueva unidad
                    this.update('dash', document.getElementById('set-dash-size').value);
                }
                this.save();
            },

            updateColor: function(key, val, save = true) {
                document.documentElement.style.setProperty('--' + key, val);
                const input = document.getElementById('col-' + (key === 'input-bg' ? 'input' : key));
                if(input) input.value = val;
                if(save) this.save();
            },

            save: function() {
                const config = {
                    sidebar: document.getElementById('set-sidebar-width').value,
                    dash: document.getElementById('set-dash-size').value,
                    font: document.getElementById('set-font-size').value,
                    layout: document.getElementById('set-layout-mode').value,
                    colors: {
                        accent: document.getElementById('col-accent').value,
                        bg: document.getElementById('col-bg').value,
                        panel: document.getElementById('col-panel').value,
                        border: document.getElementById('col-border').value,
                        text: document.getElementById('col-text').value,
                        'input-bg': document.getElementById('col-input').value
                    }
                };
                localStorage.setItem('gforge_v15_config', JSON.stringify(config));
            },

            resetLayout: function() {
                this.update('sidebar', this.defaults.sidebar);
                this.update('dash', this.defaults.dash);
                this.update('font', this.defaults.font);
                this.update('layout', this.defaults.layout);
                NOTIFY("Layout Restaurado");
            },
            
            resetColors: function() {
                Object.keys(this.defaults.colors).forEach(k => this.updateColor(k, this.defaults.colors[k]));
                NOTIFY("Colores Restaurados");
            }
        };

        function loadFile(file) {
            if (!file) return;
            APP.filename = file.name;
            const reader = new FileReader();
            reader.onload = function(e) {
                APP.nodes = DATA.parseECF(e.target.result);
                APP.activeFilter = 'all'; 
                UI.renderFilters(); 
                UI.renderList();
                NOTIFY(`Archivo Cargado: ${APP.nodes.length} nodos`);
                document.getElementById('props-scroll').innerHTML = `<div class="empty-state"><span class="material-icons">check_circle</span><h2>Cargado</h2></div>`;
                document.getElementById('visual-dashboard').style.display = 'none';
                document.getElementById('editor-header').style.display = 'none';
            };
            reader.readAsText(file);
        }

        const FILTERS = {
            'item': [ {id:'all', label:'Todos'}, {id:'weapon', label:'Armas'}, {id:'food', label:'Comida'}, {id:'component', label:'Comp'} ],
            'block': [ {id:'all', label:'Todos'}, {id:'device', label:'Devices'}, {id:'hull', label:'Bloques'}, {id:'deco', label:'Deco'} ],
            'template': [ {id:'all', label:'Todos'}, {id:'survival', label:'Survival'}, {id:'base', label:'Base'} ],
            'material': [ {id:'all', label:'Todos'}, {id:'hard', label:'Duros'}, {id:'soft', label:'Blandos'} ]
        };

        const APP = {
            mode: 'item',
            activeFilter: 'all',
            nodes: [],
            filename: 'config.ecf',
            currentIndex: undefined,

            switchMode: function(newMode) {
                this.mode = newMode;
                this.activeFilter = 'all';
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector(`.tab-btn[data-mode="${newMode}"]`).classList.add('active');
                this.nodes = [];
                document.getElementById('object-list').innerHTML = '';
                document.getElementById('props-scroll').innerHTML = `<div class="empty-state"><h2>Modo ${newMode.toUpperCase()}</h2></div>`;
                document.getElementById('visual-dashboard').style.display = 'none';
                document.getElementById('editor-header').style.display = 'none';
                UI.renderFilters();
            },
            setFilter: function(id) { this.activeFilter = id; UI.renderFilters(); UI.renderList(); }
        };

        const DATA = {
            parseECF: function(text) {
                const lines = text.split(/\r?\n/);
                const nodes = [];
                let currentBlockLines = [];
                let depth = 0;
                let insideBlock = false;
                for (let line of lines) {
                    const open = (line.match(/\{/g) || []).length;
                    const close = (line.match(/\}/g) || []).length;
                    if (!insideBlock) {
                        if (open > 0) { insideBlock = true; depth += (open - close); currentBlockLines.push(line); }
                        else nodes.push({ type: 'raw', content: line });
                    } else {
                        currentBlockLines.push(line);
                        depth += (open - close);
                        if (depth <= 0) {
                            nodes.push(this.processBlock(currentBlockLines));
                            currentBlockLines = []; insideBlock = false; depth = 0;
                        }
                    }
                }
                return nodes;
            },
            processBlock: function(lines) {
                const fullText = lines.join('\n');
                const headerMatch = fullText.match(/\{\s*(?:\+|Material|Template|Block|Item)?\s*(?:Id:\s*(\d+))?.*?(?:Name:\s*([\w]+))/i);
                let meta = { id: null, name: 'Unnamed', type: 'Generic', subType: 'generic' };
                if (headerMatch) { if(headerMatch[1]) meta.id = headerMatch[1]; if(headerMatch[2]) meta.name = headerMatch[2]; }

                const lowerText = fullText.toLowerCase();
                if (APP.mode === 'item') {
                    if (lowerText.includes('class: ranged') || lowerText.includes('damage:') || lowerText.includes('pistol') || lowerText.includes('drill')) meta.subType = 'weapon';
                    else if (lowerText.includes('class: eat') || lowerText.includes('fooddecay')) meta.subType = 'food';
                    else meta.subType = 'component';
                } else if (APP.mode === 'block') {
                    if (lowerText.includes('energyin') || lowerText.includes('cpuin')) meta.subType = 'device';
                    else meta.subType = 'hull';
                }
                return { type: 'block', meta: meta, lines: lines, parsedProps: this.extractProperties(lines), originalLines: [...lines] };
            },
            extractProperties: function(lines) {
                let props = []; let depth = 0;
                let currentParent = "Base"; 
                
                lines.forEach((line, index) => {
                    const open = (line.match(/\{/g) || []).length;
                    const close = (line.match(/\}/g) || []).length;
                    const propMatch = line.match(/^(\s*)([^:{}\/#]+):(\s*)([^#\r\n]+)(#.*)?$/);
                    const childHeaderMatch = line.match(/^(\s*)\{\s*(Child\s+[\w]+)/i);
                    
                    if (childHeaderMatch) { currentParent = childHeaderMatch[2]; }
                    if (close > open && depth === 2) { currentParent = "Base"; }

                    if (propMatch && depth >= 1) { 
                        props.push({ 
                            index: index, type: 'prop', indent: propMatch[1], key: propMatch[2].trim(), separator: propMatch[3], 
                            value: propMatch[4].trimEnd(), originalValue: propMatch[4].trimEnd(), comment: propMatch[5] || '', 
                            isNested: depth > 1, parent: currentParent
                        });
                    } else if (childHeaderMatch) {
                        props.push({ index: index, type: 'header', key: childHeaderMatch[2], indent: childHeaderMatch[1], parent: "Base" });
                    }
                    depth += (open - close);
                });
                return props;
            },
            updateProp: function(node, prop, val) {
                prop.value = val;
                node.lines[prop.index] = `${prop.indent}${prop.key}:${prop.separator}${prop.value}${prop.comment}`;
                const el = document.getElementById(`inp-${prop.index}`);
                if(el) { el.value = val; el.classList.toggle('modified', val !== prop.originalValue); }
                const dashEl = document.getElementById(`dash-${prop.index}`);
                if(dashEl) dashEl.value = val;
            },
            cloneItem: function() {
                if(APP.currentIndex === undefined) return;
                const clone = JSON.parse(JSON.stringify(APP.nodes[APP.currentIndex]));
                let newId = parseInt(clone.meta.id || 0) + 1000;
                clone.meta.name += "_Clone"; clone.meta.id = newId.toString();
                clone.lines = clone.lines.map(l => l.replace(/Id:\s*\d+/, `Id: ${newId}`).replace(/Name:\s*[\w]+/, `Name: ${clone.meta.name}`));
                clone.originalLines = [...clone.lines];
                clone.parsedProps = this.extractProperties(clone.lines);
                APP.nodes.push(clone);
                UI.renderList();
                NOTIFY("Objeto Clonado");
            },
            downloadConfig: function() {
                let content = ""; APP.nodes.forEach(n => content += (n.type === 'raw' ? n.content : n.lines.join('\n')) + "\n");
                const blob = new Blob([content], {type: "text/plain"});
                const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "EDITED_" + APP.filename; a.click();
            }
        };

        const UI = {
            renderFilters: function() {
                const container = document.getElementById('filter-container'); container.innerHTML = '';
                (FILTERS[APP.mode] || []).forEach(f => {
                    const chip = document.createElement('div'); chip.className = 'chip'; chip.innerText = f.label; chip.dataset.filter = f.id;
                    if(APP.activeFilter === f.id) chip.classList.add('active');
                    chip.onclick = () => APP.setFilter(f.id); container.appendChild(chip);
                });
            },
            renderList: function() {
                const list = document.getElementById('object-list'); list.innerHTML = '';
                const search = document.getElementById('searchInput').value.toLowerCase();
                APP.nodes.forEach((node, index) => {
                    if(node.type !== 'block') return;
                    if(search && !(node.meta.name + " " + (node.meta.id||"")).toLowerCase().includes(search)) return;
                    if(APP.activeFilter !== 'all' && node.meta.subType !== APP.activeFilter) return;

                    const li = document.createElement('li'); li.className = `list-item type-${node.meta.subType}`;
                    if(APP.currentIndex === index) li.classList.add('active');
                    let icon = 'extension';
                    if(node.meta.subType === 'weapon') icon = 'my_location';
                    if(node.meta.subType === 'food') icon = 'restaurant';
                    if(node.meta.subType === 'device') icon = 'memory';
                    
                    li.innerHTML = `<div class="item-info"><span class="item-name">${node.meta.name}</span><span class="item-id">${node.meta.id ? 'ID: ' + node.meta.id : ''}</span></div><span class="material-icons item-icon">${icon}</span>`;
                    li.onclick = () => this.loadEditor(index); list.appendChild(li);
                });
            },
            
            renderVisualDashboard: function(node) {
                const dash = document.getElementById('visual-dashboard');
                dash.innerHTML = '';
                
                const createInput = (label, key, colorClass, parentName) => {
                    const prop = node.parsedProps.find(p => p.key === key && p.parent === parentName);
                    if(!prop) return ''; 
                    return `<div class="combat-stat-box"><label class="cs-label">${label}</label><input type="text" id="dash-${prop.index}" class="cs-input ${colorClass}" value="${prop.value}" oninput="DATA.updateProp(APP.nodes[${APP.currentIndex}], APP.nodes[${APP.currentIndex}].parsedProps.find(p => p.index === ${prop.index}), this.value)"></div>`;
                };

                const groups = {};
                node.parsedProps.forEach(p => { if(!groups[p.parent]) groups[p.parent] = []; groups[p.parent].push(p); });

                if(node.meta.subType === 'weapon') {
                    dash.style.display = 'block';
                    const sortedKeys = Object.keys(groups).sort();
                    
                    sortedKeys.forEach(groupName => {
                        const interestingKeys = ['Damage', 'ROF', 'Range', 'AmmoCapacity', 'AmmoType', 'ZoomIn', 'ZoomOut', 'Recoil', 'BlastDamage', 'BulletsPerShot', 'Durability', 'EnergyIn', 'CPUIn', 'HarvestSupport', 'RepairPoints'];
                        const classProp = groups[groupName].find(p => p.key === 'Class');
                        const className = classProp ? classProp.value : '';
                        const hasInteresting = groups[groupName].some(p => interestingKeys.includes(p.key) || p.key === 'Class');
                        
                        if (hasInteresting) {
                            let title = groupName === 'Base' ? 'General' : groupName;
                            if (className) title += ` [${className}]`; 
                            let html = `<div class="mode-section"><div class="mode-title"><span class="material-icons" style="font-size:1.2em">tune</span> ${title}</div><div class="combat-grid">`;
                            html += createInput('DAÑO', 'Damage', 'inp-dmg', groupName);
                            html += createInput('CADENCIA', 'ROF', 'inp-rof', groupName);
                            html += createInput('ZOOM IN', 'ZoomIn', 'inp-zoom', groupName);
                            html += createInput('ZOOM OUT', 'ZoomOut', 'inp-zoom', groupName);
                            html += createInput('RECARGA', 'ReloadDelay', 'inp-dur', groupName);
                            html += createInput('RETROCESO', 'Recoil', '', groupName);
                            html += createInput('DISPERSIÓN', 'BulletSpread', '', groupName);
                            html += createInput('DAÑO EXP.', 'BlastDamage', 'inp-dmg', groupName);
                            html += createInput('PERDIGONES', 'BulletsPerShot', '', groupName);
                            html += createInput('DURABILIDAD', 'Durability', 'inp-dur', groupName);
                            html += createInput('RANGO', 'Range', 'inp-range', groupName);
                            html += createInput('MUNICIÓN', 'AmmoCapacity', 'inp-ammo', groupName);
                            html += createInput('TIPO AMMO', 'AmmoType', 'inp-ammo', groupName);
                            html += createInput('ENERGÍA', 'EnergyIn', 'inp-energy', groupName);
                            html += createInput('CPU', 'CPUIn', 'inp-dur', groupName);
                            html += createInput('P. REPARACIÓN', 'RepairPoints', 'inp-repair', groupName);
                            html += `</div></div>`;
                            dash.innerHTML += html;
                        }
                    });
                } 
                else if (node.meta.subType === 'food') {
                    dash.style.display = 'block';
                    const getVal = (k) => { const p = node.parsedProps.find(pr => pr.key === k); return p ? p.value : '0'; };
                    const getIdx = (k) => { const p = node.parsedProps.find(pr => pr.key === k); return p ? p.index : -1; };
                    const mkFoodInp = (icon, lbl, key, cls) => {
                        const idx = getIdx(key); if(idx === -1) return '';
                        return `<div class="food-item"><span class="material-icons food-icon ${cls}">${icon}</span><span class="stat-label">${lbl}</span><input type="text" class="food-val ${cls}" value="${getVal(key)}" oninput="DATA.updateProp(APP.nodes[${APP.currentIndex}], APP.nodes[${APP.currentIndex}].parsedProps[${idx}], this.value)"></div>`;
                    };
                    dash.innerHTML = '<div class="food-grid">' + mkFoodInp('favorite','SALUD','AddHealth','c-health') + mkFoodInp('set_meal','HAMBRE','AddFood','c-food') + mkFoodInp('bolt','STAMINA','AddStamina','c-stamina') + '</div>';
                }
                else { dash.style.display = 'none'; }
            },

            loadEditor: function(index) {
                APP.currentIndex = index;
                const node = APP.nodes[index];
                const container = document.getElementById('props-scroll');
                const header = document.getElementById('editor-header');
                const listItems = document.querySelectorAll('.list-item');
                listItems.forEach(i => i.classList.remove('active'));
                if(listItems[index]) listItems[index].classList.add('active');
                
                header.style.display = 'flex';
                // Si estamos en modo "Right", primero el scroll wrapper, luego el dashboard
                document.getElementById('editor-title').innerHTML = `<span class="material-icons">edit_note</span> ${node.meta.name}`;
                this.renderVisualDashboard(node);
                
                container.innerHTML = '';
                node.parsedProps.forEach(prop => {
                    if(prop.type === 'header') {
                        const h = document.createElement('div'); h.className = 'nested-header';
                        let icon = 'subdirectory_arrow_right';
                        if(prop.key.includes('Inputs')) icon = 'shopping_cart'; if(prop.key.includes('Drop')) icon = 'delete_sweep';
                        h.innerHTML = `<span class="material-icons">${icon}</span> ${prop.key}`; container.appendChild(h);
                    } else if (prop.type === 'prop') {
                        const row = document.createElement('div'); row.className = 'prop-row'; if(prop.isNested) row.classList.add('nested-block');
                        const label = document.createElement('div'); label.className = 'prop-key'; label.innerText = prop.key; label.title = prop.key;
                        const input = document.createElement('input'); input.type = 'text'; input.className = 'prop-val'; input.value = prop.value; input.id = `inp-${prop.index}`;
                        if(prop.value !== prop.originalValue) input.classList.add('modified');
                        input.oninput = (e) => DATA.updateProp(node, prop, e.target.value);
                        row.appendChild(label); row.appendChild(input); container.appendChild(row);
                    }
                });
            },
            
            showCodeInspector: function(fullFile = false) {
                const container = document.getElementById('code-container'); container.innerHTML = '';
                const title = document.getElementById('modal-title');
                let nodesToShow = [];
                if(fullFile) { title.innerText = "INSPECTOR GLOBAL (ARCHIVO COMPLETO)"; nodesToShow = APP.nodes; } 
                else { title.innerText = "INSPECTOR DE ÍTEM (ECF)"; nodesToShow = (APP.currentIndex !== undefined) ? [APP.nodes[APP.currentIndex]] : []; }
                if(nodesToShow.length === 0 && !fullFile) { NOTIFY("Selecciona un ítem primero"); return; }
                const fragment = document.createDocumentFragment();
                nodesToShow.forEach(node => {
                    if(node.type === 'raw') {
                         if(fullFile) { const div = document.createElement('div'); div.textContent = node.content; div.style.color = "#666"; fragment.appendChild(div); }
                    } else {
                        node.lines.forEach((line, idx) => {
                            const prop = node.parsedProps.find(p => p.index === idx);
                            let cls = ''; let extra = '';
                            if(prop && prop.value !== prop.originalValue) { cls = 'line-mod'; extra = `   << ANTES: ${prop.originalValue}`; }
                            const div = document.createElement('div'); if(cls) div.className = cls; div.textContent = line + extra; fragment.appendChild(div);
                        });
                        fragment.appendChild(document.createElement('br'));
                    }
                });
                container.appendChild(fragment);
                document.getElementById('code-modal').style.display = 'flex';
            },
            
            showFullCode: function() {
                if(APP.nodes.length > 5000) { if(!confirm("El archivo es muy grande. ¿Mostrar todo puede ser lento?")) return; }
                this.showCodeInspector(true);
            },

            toggleSettings: function() {
                const el = document.getElementById('settings-modal');
                el.style.display = (el.style.display === 'flex') ? 'none' : 'flex';
            }
        };

        // INICIALIZACIÓN
        CONFIG.init();
        UI.renderFilters();
        document.getElementById('fileInput').addEventListener('change', (e) => loadFile(e.target.files[0]));
    </script>
</body>
</html>
